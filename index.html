<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UlluSeriesHub - Video App</title>
    <!-- Google Font Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Roboto', 'Arial', sans-serif;
            background: linear-gradient(to right, #000000, #1F2940);
            color: #ffffff;
            line-height: 1.6;
            overflow-x: hidden;
        }
        button, .telegram-join-btn, .menu-icon { cursor: pointer; font-family: inherit; }

        /* --- Views --- */
        .view { display: none; }
        .view.active { display: block; }

        /* --- Header --- */
        .app-header { background-color: #0F1A2E; box-shadow: 0 2px 5px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 1000; }
        .header-content-wrapper { max-width: 1000px; margin: 0 auto; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .menu-icon { font-size: 1.8em; color: #ffffff; padding: 5px 10px 5px 0; margin-right: 10px; line-height: 1; user-select: none; }
        .header-title-text {
            font-family: 'Poppins', sans-serif; font-size: 1.4em; font-weight: 700; flex-grow: 1; letter-spacing: -1px;
            background: linear-gradient(90deg, #F97316, #FBBF24); -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        .telegram-join-btn { background-color: #0088cc; color: white; padding: 7px 14px; border-radius: 20px; text-decoration: none; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease-in-out; white-space: nowrap; border: none; }
        .telegram-join-btn:hover { background-color: #0077b3; }

        /* --- Category Sidebar --- */
        .category-sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background-color: #0c1524; box-shadow: 2px 0 8px rgba(0,0,0,0.5); padding: 20px; transition: left 0.3s ease-in-out; z-index: 1002; overflow-y: auto; }
        .category-sidebar.active { left: 0; }
        .category-sidebar-title { font-size: 1.3em; margin-bottom: 15px; color: #e0e0e0; border-bottom: 1px solid #1F2940; padding-bottom: 10px; }
        .category-list { list-style: none; }
        .category-list-item { padding: 10px 5px; color: #cccccc; cursor: pointer; border-radius: 4px; transition: background-color 0.2s, color 0.2s; font-size: 1em; }
        .category-list-item:hover { background-color: #1F2940; color: #ffffff; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; display: none; transition: opacity 0.3s ease-in-out; opacity: 0; }
        .sidebar-overlay.active { display: block; opacity: 1; }

        /* --- Search Bar --- */
        .search-bar-container { padding: 10px 20px; background-color: #0F1A2E; position: sticky; z-index: 999; }
        .search-input-wrapper { position: relative; max-width: 760px; margin: 0 auto; }
        #searchVideosInput { width: 100%; padding: 10px 18px; font-size: 1em; border-radius: 25px; border: 1px solid #2a3b58; background-color: #182237; color: #e0e0e0; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        #searchVideosInput::placeholder { color: #778899; }
        #searchVideosInput:focus { border-color: #3F51B5; box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3); }
        
        /* --- Video List --- */
        .video-grid-container { max-width: 800px; margin: 20px auto; padding: 0 10px; min-height: 300px; }
        .video-item { background-color: #1e1e1e; border-radius: 6px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.4); cursor: pointer; }
        .video-thumbnail-container { position: relative; width: 100%; padding-bottom: 56.25%; background-color: #333; }
        .video-thumbnail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .video-duration-overlay { position: absolute; background-color: rgba(0,0,0,0.7); color: white; padding: 3px 7px; border-radius: 3px; font-size: 0.75em; font-weight: 500; top: 8px; left: 8px; }
        .video-views-overlay { position: absolute; top: 8px; right: 8px; background-color: rgba(0,0,0,0.7); color: white; padding: 3px 7px; border-radius: 3px; font-size: 0.75em; font-weight: 500; }
        .video-info-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px 10px 8px 10px; background: linear-gradient(to top, rgba(0,0,0,0.85) 65%, transparent); }
        .video-title { font-size: 1.1em; font-weight: 600; color: #ffffff; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }

        /* MODIFIED: Pagination Styles */
        .pagination-controls { display: flex; justify-content: center; align-items: center; padding: 15px 0; margin-top: 15px; }
        .pagination-controls button { background-color: #3F51B5; color: white; border: none; padding: 8px 12px; margin: 0 5px; border-radius: 4px; font-size: 0.85em; transition: background-color 0.2s; }
        .pagination-controls button:disabled { background-color: #444; color: #888; cursor: not-allowed; }
        .pagination-info { font-size: 0.9em; color: #ccc; margin: 0 10px; }
        
        /* --- Loaders --- */
        #fullScreenLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0c1524; display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3F51B5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODIFIED: Skeleton Loader Colors */
        .skeleton-item { background-color: #182237; border-radius: 6px; margin-bottom: 20px; overflow: hidden; }
        .skeleton-thumbnail { width: 100%; padding-bottom: 56.25%; background-color: #2a3b58; position: relative; overflow: hidden; }
        .skeleton-info { padding: 10px 12px; }
        .skeleton-title { height: 20px; background-color: #2a3b58; border-radius: 4px; margin-bottom: 8px; position: relative; overflow: hidden; }
        .skeleton-title.short { width: 60%; }
        .shimmer::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { transform: translateX(0); } 100% { transform: translateX(200%); } }

        /* --- Player View & Other Styles --- */
        #playerViewContainer { padding: 10px; max-width: 1000px; margin: 0 auto; }
        #backToListBtn { background-color: #3F51B5; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 0.9em; margin-top: 15px; margin-bottom: 20px; }
        #playerVideoTitle { font-size: 1.3em; margin-bottom: 10px; word-break: break-word; }
        #videoPlayerWrapper { position: relative; width: 100%; background-color: #000; aspect-ratio: 16 / 9; }
        #relatedVideosContainer { margin-top: 20px; border-top: 1px solid #2a3b58; padding-top: 15px; }
        .related-videos-title { font-size: 1.1em; font-weight: 500; color: #e0e0e0; margin-bottom: 12px; }
        .related-video-item { display: flex; align-items: flex-start; margin-bottom: 12px; cursor: pointer; }
        .related-video-thumbnail { width: 120px; min-width: 120px; height: 67px; object-fit: cover; border-radius: 4px; margin-right: 12px; background-color: #333; }
        .related-video-info { flex-grow: 1; overflow: hidden; }
        .related-video-title { font-size: 0.9em; color: #e0e0e0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        body.video-is-fullscreen { overflow: hidden; }
        body.video-is-fullscreen .app-header, body.video-is-fullscreen #playerVideoTitle, body.video-is-fullscreen #backToListBtn, body.video-is-fullscreen #relatedVideosContainer { display: none !important; }
        body.video-is-fullscreen #playerViewContainer { padding: 0; max-width: 100%; }
        body.video-is-fullscreen #videoPlayerWrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; }
        #searchResultsContainer { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: #0c1524; border: 1px solid #2a3b58; border-radius: 8px; margin-top: 8px; max-height: 70vh; overflow-y: auto; z-index: 1001; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        #searchResultsContainer.active { display: block; }
        .search-result-item { display: flex; align-items: flex-start; padding: 10px; cursor: pointer; border-bottom: 1px solid #1F2940; transition: background-color 0.2s; }
        .search-result-item:hover { background-color: #1F2940; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-thumbnail { width: 100px; min-width: 100px; height: 56px; object-fit: cover; border-radius: 4px; margin-right: 12px; background-color: #333; }
        .search-result-info { flex-grow: 1; overflow: hidden; }
        .search-result-title { font-size: 0.9em; color: #e0e0e0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .no-search-results { padding: 20px; text-align: center; color: #999; }
    </style>
</head>
<body>
    <div id="fullScreenLoader">
        <div class="loader"></div>
    </div>

    <div id="categorySidebar" class="category-sidebar"></div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <header class="app-header">
        <div class="header-content-wrapper">
            <span id="menuIcon" class="menu-icon">☰</span>
            <span class="header-title-text">UlluSeriesHub</span>
            <a href="https://t.me/your_channel_name" target="_blank" class="telegram-join-btn">Join Telegram</a>
        </div>
    </header>

    <div class="search-bar-container" style="display: none;">
        <div class="search-input-wrapper">
            <input type="text" id="searchVideosInput" placeholder="Search for videos..." autocomplete="off">
            <div id="searchResultsContainer"></div>
        </div>
    </div>

    <div id="listView" class="view active">
        <main class="video-grid-container" id="videoGrid"></main>
        <nav class="pagination-controls" id="paginationControlsEl"></nav>
    </div>

    <div id="playerView" class="view">
        <div id="playerViewContainer">
            <h2 id="playerVideoTitle"></h2>
            <div id="videoPlayerWrapper"></div>
            <button id="backToListBtn">← Back to List</button>
            <div id="relatedVideosContainer"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyC5pjNgY6SR3e1YeYAdf8glM29Gpc2Whkk",
          authDomain: "tournament-4dd48.firebaseapp.com",
          databaseURL: "https://tournament-4dd48-default-rtdb.firebaseio.com",
          projectId: "tournament-4dd48",
          storageBucket: "tournament-4dd48.firebasestorage.app",
          messagingSenderId: "432883056274",
          appId: "1:432883056274:web:c23afb68be69e33f20304b"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Global Variables & Element Selectors ---
        const listView = document.getElementById('listView');
        const playerView = document.getElementById('playerView');
        const videoGrid = document.getElementById('videoGrid');
        const searchVideosInput = document.getElementById('searchVideosInput');
        const menuIcon = document.getElementById('menuIcon');
        const categorySidebar = document.getElementById('categorySidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const paginationControlsEl = document.getElementById('paginationControlsEl');
        const searchResultsContainer = document.getElementById('searchResultsContainer');

        let allVideosMaster = [];
        let currentFilteredVideos = []; // MODIFIED: This will hold the currently filtered list
        let currentPage = 1;
        const videosPerPage = 6;
        let sampleCategories = ["All"];
        let currentlyPlayingVideo = null;

        // --- Helper Functions ---
        function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
        function slugify(text) { if (!text) return ''; return text.toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, ''); }
        function formatViews(views) { if (views === null || views === undefined) return '0'; if (views < 1000) return `${views}`; if (views < 1000000) return `${(views / 1000).toFixed(1)}K`; return `${(views / 1000000).toFixed(1)}M`; }
        
        // --- Main App Initialization & Routing ---
        async function initializeApp() {
            await Promise.all([
                fetchCategoriesFromFirebase(),
                fetchAllVideos() // Fetch all videos at start for search and pagination
            ]);
            renderCategories();
            adjustHeaderPosition();
            await handleRouting();
            hideFullScreenLoader();
        }

        async function handleRouting() {
            const path = window.location.pathname; const segments = path.split('/').filter(Boolean);
            stopAllPlayers();
            if (segments.length === 0) { displayCategory("All"); }
            else if (segments.length === 1) { const categorySlug = segments[0]; const categoryName = sampleCategories.find(c => slugify(c) === categorySlug) || "All"; displayCategory(categoryName); }
            else if (segments.length === 2) { const [categorySlug, videoSlug] = segments; const video = allVideosMaster.find(v => slugify(v.category) === categorySlug && slugify(v.title) === videoSlug); if (video) { openPlayerView(video, false); } else { displayCategory("All"); } }
            else { displayCategory("All"); }
        }
        
        function displayCategory(categoryName) {
            showView(listView);
            currentFilteredVideos = (categoryName === "All") ? allVideosMaster : allVideosMaster.filter(v => v.category === categoryName);
            currentPage = 1;
            searchVideosInput.value = "";
            hideSearchResults();
            displayPage(1);
        }

        // --- View & Component Rendering ---
        function showView(viewToShow) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); if (viewToShow) viewToShow.classList.add('active'); document.querySelector('.search-bar-container').style.display = (viewToShow === listView) ? 'block' : 'none'; }
        function adjustHeaderPosition() { const headerHeight = document.querySelector('.app-header').offsetHeight; document.querySelector('.search-bar-container').style.top = `${headerHeight}px`; }
        async function fetchCategoriesFromFirebase() { const snapshot = await database.ref('/categories').once('value'); if (snapshot.val()) { sampleCategories = ["All", ...Object.keys(snapshot.val())]; } }
        async function fetchAllVideos() { const snapshot = await database.ref('/videos').once('value'); if(snapshot.val()) { allVideosMaster = Object.values(snapshot.val()).map(v => ({...v, views: v.views || 0})).reverse(); } }
        
        function renderCategories() {
            categorySidebar.innerHTML = `<h3 class="category-sidebar-title">Categories</h3>`; const ul = document.createElement('ul'); ul.className = 'category-list';
            sampleCategories.forEach(categoryName => { const li = document.createElement('li'); li.className = 'category-list-item'; li.textContent = categoryName; li.onclick = () => navigateToCategory(categoryName); ul.appendChild(li); });
            categorySidebar.appendChild(ul);
        }
        function navigateToCategory(categoryName) { const newUrl = (categoryName === "All") ? '/' : `/${slugify(categoryName)}/`; history.pushState({ category: categoryName }, categoryName, newUrl); handleRouting(); toggleSidebar(); }
        function hideFullScreenLoader() { const loader = document.getElementById('fullScreenLoader'); loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; }, 500); }

        // NEW: displayPage function to handle client-side pagination
        function displayPage(page) {
            currentPage = page;
            videoGrid.innerHTML = ''; // Clear the grid
            
            const startIndex = (currentPage - 1) * videosPerPage;
            const endIndex = startIndex + videosPerPage;
            const paginatedVideos = currentFilteredVideos.slice(startIndex, endIndex);

            appendVideosToGrid(paginatedVideos);
            setupPagination();
            window.scrollTo(0, 0);
        }

        function appendVideosToGrid(videos) {
            if (videos.length === 0) { videoGrid.innerHTML = `<p>No videos found.</p>`; return; }
            videos.forEach(video => {
                const item = document.createElement('article'); item.className = 'video-item';
                item.innerHTML = `<div class="video-thumbnail-container"><img src="${video.thumbnailUrl || 'https://via.placeholder.com/640x360.png?text=No+Thumb'}" alt="${video.title}" class="video-thumbnail" loading="lazy">${video.duration ? `<div class="video-duration-overlay">${video.duration}</div>` : ''}<div class="video-views-overlay">${formatViews(video.views)} views</div><div class="video-info-overlay"><h3 class="video-title">${video.title}</h3></div></div>`;
                item.onclick = () => openPlayerView(video); videoGrid.appendChild(item);
            });
        }

        // MODIFIED: Full pagination logic
        function setupPagination() {
            paginationControlsEl.innerHTML = '';
            const totalPages = Math.ceil(currentFilteredVideos.length / videosPerPage);
            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button'); prevBtn.textContent = 'Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) displayPage(currentPage - 1); };
            paginationControlsEl.appendChild(prevBtn);

            const pageInfo = document.createElement('span');
            pageInfo.className = 'pagination-info';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            paginationControlsEl.appendChild(pageInfo);

            const nextBtn = document.createElement('button'); nextBtn.textContent = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { if (currentPage < totalPages) displayPage(currentPage + 1); };
            paginationControlsEl.appendChild(nextBtn);
        }

        // --- Player & Search Logic ---
        function stopAllPlayers() { document.getElementById('videoPlayerWrapper').innerHTML = ''; currentlyPlayingVideo = null; }
        async function openPlayerView(video, updateHistory = true) {
            database.ref(`/videos/${video.id}/views`).transaction(v => (v || 0) + 1); video.views = (video.views || 0) + 1;
            stopAllPlayers(); currentlyPlayingVideo = video;
            if (updateHistory) { history.pushState({ videoId: video.id }, video.title, `/${slugify(video.category)}/${slugify(video.title)}`); }
            
            document.getElementById('playerVideoTitle').textContent = video.title;
            const playerWrapper = document.getElementById('videoPlayerWrapper');

            if (video.type === 'direct') {
                const mainPlayer = document.createElement('video');
                Object.assign(mainPlayer, { style: 'width:100%;height:100%', controls: true, playsinline: true, src: video.videoUrl });
                mainPlayer.setAttribute('webkit-playsinline', ''); mainPlayer.setAttribute('controlsList', 'nodownload');
                playerWrapper.appendChild(mainPlayer); mainPlayer.play().catch(e => console.warn("Autoplay was prevented."));
            } else {
                const iframe = document.createElement('iframe');
                Object.assign(iframe, { style: 'width:100%;height:100%;border:none', allow: 'autoplay; fullscreen', allowfullscreen: true });
                let url = '';
                if (video.type === 'youtube') url = `${video.videoUrl}?autoplay=1&rel=0`;
                else if (video.type === 'gdrive') { const fileId = (video.videoUrl.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/) || [])[1]; url = fileId ? `https://drive.google.com/file/d/${fileId}/preview` : ''; }
                if (url) { iframe.src = url; playerWrapper.appendChild(iframe); }
            }
            renderRelatedVideos(video); showView(playerView); window.scrollTo(0, 0);
        }
        function showSearchResults(term) {
            const results = allVideosMaster.filter(v => v.title.toLowerCase().includes(term));
            searchResultsContainer.innerHTML = '';
            if (results.length > 0) {
                results.slice(0, 15).forEach(video => {
                    const item = document.createElement('div'); item.className = 'search-result-item';
                    item.innerHTML = `<img src="${video.thumbnailUrl||'https://via.placeholder.com/100x56.png?text=N/A'}" alt="${video.title}" class="search-result-thumbnail" loading="lazy"><div class="search-result-info"><h4 class="search-result-title">${video.title}</h4></div>`;
                    item.onclick = () => { hideSearchResults(); openPlayerView(video); };
                    searchResultsContainer.appendChild(item);
                });
            } else { searchResultsContainer.innerHTML = `<div class="no-search-results">No videos match your search.</div>`; }
            searchResultsContainer.classList.add('active');
        }
        function hideSearchResults() { searchResultsContainer.classList.remove('active'); }
        function renderRelatedVideos(currentVideo) {
            const container = document.getElementById('relatedVideosContainer'); container.innerHTML = '';
            const related = allVideosMaster.filter(v => v.id !== currentVideo.id && v.category === currentVideo.category).sort(() => 0.5 - Math.random()).slice(0, 5);
            if (related.length === 0) return;
            container.innerHTML = `<h3 class="related-videos-title">Up Next</h3>`;
            related.forEach(video => {
                const item = document.createElement('div'); item.className = 'related-video-item';
                item.innerHTML = `<img src="${video.thumbnailUrl||'https://via.placeholder.com/120x67.png?text=N/A'}" alt="${video.title}" class="related-video-thumbnail" loading="lazy"><div class="related-video-info"><h4 class="related-video-title">${video.title}</h4></div>`;
                item.onclick = () => openPlayerView(video); container.appendChild(item);
            });
        }
        function toggleSidebar() { categorySidebar.classList.toggle('active'); sidebarOverlay.classList.toggle('active'); }

        // --- Event Listeners ---
        document.getElementById('backToListBtn').onclick = () => { if (currentlyPlayingVideo) navigateToCategory(currentlyPlayingVideo.category); else navigateToCategory("All"); };
        searchVideosInput.addEventListener('input', debounce(e => { const term = e.target.value.toLowerCase().trim(); if (term.length > 2) showSearchResults(term); else hideSearchResults(); }, 400));
        document.onclick = e => { if (!searchVideosInput.contains(e.target) && !searchResultsContainer.contains(e.target)) hideSearchResults(); };
        menuIcon.onclick = toggleSidebar;
        sidebarOverlay.onclick = toggleSidebar;
        window.onresize = adjustHeaderPosition;
        window.onpopstate = () => handleRouting();
        function handleFullscreenChange() { document.body.classList.toggle('video-is-fullscreen', !!(document.fullscreenElement || document.webkitFullscreenElement)); }
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        
        // --- App Start ---
        window.onload = initializeApp;
    </script>
</body>
</html>
